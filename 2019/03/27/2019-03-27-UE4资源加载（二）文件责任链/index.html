<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="utf-8">
  

  
  <title>UE4资源加载（二）文件责任链 | 芭蕉不解的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言​        这是关于资源加载的第二篇内容，前一篇内容讲了，从StaticLoadObject出发，是如何把自身的数据以及依赖对象的数据给加载到内存中的，这一篇内容将继续讲文件读取的相关内容。 责任链设计模式​        在进入主题之前必须先了解一下UE4为了文件读取所采用的设计模式，责任链设计模式。这是网上找的一篇讲解 http://www.cnblogs.com/java-my-l">
<meta property="og:type" content="article">
<meta property="og:title" content="UE4资源加载（二）文件责任链">
<meta property="og:url" content="http://yoursite.com/2019/03/27/2019-03-27-UE4资源加载（二）文件责任链/index.html">
<meta property="og:site_name" content="芭蕉不解的博客">
<meta property="og:description" content="前言​        这是关于资源加载的第二篇内容，前一篇内容讲了，从StaticLoadObject出发，是如何把自身的数据以及依赖对象的数据给加载到内存中的，这一篇内容将继续讲文件读取的相关内容。 责任链设计模式​        在进入主题之前必须先了解一下UE4为了文件读取所采用的设计模式，责任链设计模式。这是网上找的一篇讲解 http://www.cnblogs.com/java-my-l">
<meta property="og:locale" content="default">
<meta property="og:image" content="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/2.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/4.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/5.jpg">
<meta property="og:image" content="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/3.jpg">
<meta property="og:updated_time" content="2019-05-24T12:43:26.444Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="UE4资源加载（二）文件责任链">
<meta name="twitter:description" content="前言​        这是关于资源加载的第二篇内容，前一篇内容讲了，从StaticLoadObject出发，是如何把自身的数据以及依赖对象的数据给加载到内存中的，这一篇内容将继续讲文件读取的相关内容。 责任链设计模式​        在进入主题之前必须先了解一下UE4为了文件读取所采用的设计模式，责任链设计模式。这是网上找的一篇讲解 http://www.cnblogs.com/java-my-l">
<meta name="twitter:image" content="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/2.jpg">
  
    <link rel="alternate" href="/atom.xml" title="芭蕉不解的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">芭蕉不解的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-2019-03-27-UE4资源加载（二）文件责任链" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/03/27/2019-03-27-UE4资源加载（二）文件责任链/" class="article-date">
  <time datetime="2019-03-26T16:00:00.000Z" itemprop="datePublished">2019-03-27</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      UE4资源加载（二）文件责任链
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>​        这是关于资源加载的第二篇内容，前一篇内容讲了，从StaticLoadObject出发，是如何把自身的数据以及依赖对象的数据给加载到内存中的，这一篇内容将继续讲文件读取的相关内容。</p>
<h2 id="责任链设计模式"><a href="#责任链设计模式" class="headerlink" title="责任链设计模式"></a>责任链设计模式</h2><p>​        在进入主题之前必须先了解一下UE4为了文件读取所采用的设计模式，责任链设计模式。这是网上找的一篇讲解 <a href="http://www.cnblogs.com/java-my-life/archive/2012/05/28/2516865.html" target="_blank" rel="noopener">http://www.cnblogs.com/java-my-life/archive/2012/05/28/2516865.html</a></p>
<p>　　来考虑这样一个功能:申请聚餐费用的管理。</p>
<p>　　很多公司都是这样的福利，就是项目组或者是部门可以向公司申请一些聚餐费用，用于组织项目组成员或者是部门成员进行聚餐活动。</p>
<p>　　申请聚餐费用的大致流程一般是：由申请人先填写申请单，然后交给领导审批，如果申请批准下来，领导会通知申请人审批通过，然后申请人去财务领取费用，如果没有批准下来，领导会通知申请人审批未通过，此事也就此作罢。</p>
<p>　　不同级别的领导，对于审批的额度是不一样的，比如，项目经理只能审批500元以内的申请；部门经理能审批1000元以内的申请；而总经理可以审核任意额度的申请。</p>
<p>　　也就是说，当某人提出聚餐费用申请的请求后，该请求会经由项目经理、部门经理、总经理之中的某一位领导来进行相应的处理，但是提出申请的人并不知道最终会由谁来处理他的请求，一般申请人是把自己的申请提交给项目经理，或许最后是由总经理来处理他的请求。</p>
<p>　　可以使用责任链模式来实现上述功能：当某人提出聚餐费用申请的请求后，该请求会在 <strong>项目经理—〉部门经理—〉总经理</strong> 这样一条领导处理链上进行传递，发出请求的人并不知道谁会来处理他的请求，每个领导会根据自己的职责范围，来判断是处理请求还是把请求交给更高级别的领导，只要有领导处理了，传递就结束了。</p>
<p>　　需要把每位领导的处理独立出来，实现成单独的职责处理对象，然后为它们提供一个公共的、抽象的父职责对象，这样就可以在客户端来动态地组合职责链，实现不同的功能要求了。</p>
<p>​        项目经理可以解决（完成 ），不可以解决-&gt;抛给部门经理去处理-&gt;部门经理不能解决再抛给总经理去处理。各人负责各自领域内的责任 。</p>
<h2 id="UE4文件责任链"><a href="#UE4文件责任链" class="headerlink" title="UE4文件责任链"></a>UE4文件责任链</h2><p>在UE4中对文件读取也采用了责任链的设计模式。好处是将负责一类功能的（比如专门负责读取Pak文件）给单独抽取了出来，保持类的单一职责。在这个链上的各个处理器只负责分内的事，如果请求不是自己处理直接抛给下一个就好了。链上的每一个环都继承自IPlatformFile接口。</p>
<img src="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/2.jpg">

<p><a href="https://zhuanlan.zhihu.com/p/35925797" target="_blank" rel="noopener">https://zhuanlan.zhihu.com/p/35925797</a></p>
<p>在加载uasset文件的时候调用到了方法</p>
<p><code>Handle = FPlatformFileManager::Get().GetPlatformFile().OpenAsyncRead(InFileName);</code></p>
<p>其中FPlatformFileManager 是一个单例的管理器，持有一个TopmostPlayformFile，也就是责任链的头部位置。每个具体实现的类在初始化的时候都会持有下一个IPlatformFile的引用。这样TopmostPlayformFile处理不了的文件可以一直往下传递，直到被处理或者传递到链的末尾。</p>
<p>相关方法如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">FPlatformFileManager </span><br><span class="line"></span><br><span class="line"><span class="comment">/** Currently used platform file. */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">IPlatformFile</span>* <span class="title">TopmostPlatformFile</span>;</span> <span class="comment">//类里的唯一变量</span></span><br><span class="line"></span><br><span class="line">FPlatformFileManager&amp; FPlatformFileManager::Get() <span class="comment">//单例模式</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">static</span> FPlatformFileManager Singleton;</span><br><span class="line">  <span class="keyword">return</span> Singleton;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">IPlatformFile&amp; FPlatformFileManager::GetPlatformFile() <span class="comment">//获得链顶部的IPlatform处理器</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (TopmostPlatformFile == <span class="literal">NULL</span>)</span><br><span class="line">  &#123;</span><br><span class="line">     TopmostPlatformFile = &amp;IPlatformFile::GetPlatformPhysical();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> *TopmostPlatformFile;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>如何生成责任链：</strong></p>
<p>以安卓为例，启动过程：</p>
<ol>
<li><p>在LaunchAndroid.cpp调用AndroidMain 程序入口</p>
</li>
<li><p>调用FEngineLoop::PreInit</p>
</li>
<li><p>在PreInit中调用 LaunchCheckForFileOverride</p>
</li>
<li><p>在LaunchCheckForFileOverride生成读取文件的责任链</p>
</li>
</ol>
<img src="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/4.jpg">

<p>最开始责任链只有一个physical platform file，随后加入读取PakFile的处理器。此时physical platform file为PakFile的LowerLevel，也就是处理器的下一环。</p>
<img src="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/5.jpg">

<p>ConditionallyCreateFileWrapper在获得相应的IPlatformFile之后会调用Initialize初始化方法，CurrentPlatformFile也就成了新生成的IPlatformFile的LowerLevel。</p>
<p><strong>FPakPlatformFile的结构</strong></p>
<p>生成责任链后，链上的每一环各自负责自己的内容，其中FPakPlatformFile是专门处理Pak的一环。这里对FPakPlatformFile只做简要介绍，下一篇内容会详细讲解Pak格式相关。</p>
<img src="https://raw.githubusercontent.com/BAJIAObujie/BAJIAObujie.github.io/master/img/UE4ResourceLoad2/3.jpg" width="600px">

<ul>
<li><p>LowerLevel 链上下一环处理器</p>
</li>
<li><p>TArray<fpaklistentry> PakFiles存储所有Pak文件</fpaklistentry></p>
</li>
</ul>
<p>FPakPlatformFile的PakFiles 将几个指定目录下所有pak为后缀的文件挂载到内存中，是挂载而不是加载，加载意味着整个pak文件数据都加载到内存中。而挂载不同，pak是打包了很多uasset、uexp文件的这样一个文件。挂载仅仅只是对这些uasset生成一个目录，加载某一个uasset文件的时候，就可以在这个目录下查找，这个pak是否含有这个uasset文件，如果有，才把pak中对应资源相关的数据给加载到内存。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2019/03/27/2019-03-27-UE4资源加载（二）文件责任链/" data-id="cjyqk8cjs0000kwvpk2tb6s59" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2019/03/27/2019-03-27-UE4资源加载（一）从StaticLoadObject开始/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          UE4资源加载（一）从StaticLoadObject开始
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/05/">May 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/04/">April 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/07/31/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2019/06/29/2019-06-29-写在毕业一周年/">写在毕业一周年</a>
          </li>
        
          <li>
            <a href="/2019/06/14/2019-06-14-翻译：可编程渲染管线之定制化着色器（二）/">翻译：可编程渲染管线之定制化着色器（二）</a>
          </li>
        
          <li>
            <a href="/2019/06/12/2019-06-12-UE4安卓打包问题/">UE4安卓打包问题</a>
          </li>
        
          <li>
            <a href="/2019/06/03/2019-06-03-UE4的热更新与HTTP（三）/">UE4的热更新与HTTP（三）</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 BAJIAObujie<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>